---
- name: Configure IPv4 and access ports on Cisco switches
  hosts: switches
  gather_facts: no
  connection: network_cli

  tasks:

    - name: Safety check â€“ ensure mgmt_ip matches ansible_host
      fail:
        msg: >
          Management IP ({{ mgmt_ip }}) does not match ansible_host ({{ ansible_host }}).
          Playbook stopped to prevent misconfiguration.
      when: mgmt_ip != ansible_host

    - name: Configure management SVI (VLAN 1)
      ios_config:
        parents: interface Vlan1
        lines:
          - ip address {{ mgmt_ip }} 255.255.255.0
          - no shutdown

    - name: Configure default gateway
      ios_config:
        lines:
          - ip default-gateway {{ mgmt_gw }}

    - name: Configure access ports GigabitEthernet1/0/1-28
      ios_config:
        parents: interface range GigabitEthernet1/0/1 - 28
        lines:
          - description USER_ACCESS_PORT
          - switchport mode access
          - switchport access vlan 10
          - spanning-tree portfast
          - no shutdown
`
